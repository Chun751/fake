<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è§’è‰²è¡Œå‹•å€¼è¨ˆç®—å™¨</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 800px;
      margin: 2em auto;
      padding: 0 10px;
    }
    h2 {
      margin-top: 2em;
    }
    .form-row {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .form-row label {
      flex: 0 0 160px;
      min-width: 120px;
      margin-bottom: 6px;
    }
    .form-row input, .form-row select {
      flex: 1;
      max-width: 120px;
      padding: 6px 8px;
      font-size: 1em;
    }
    .checkbox-row {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
      flex-wrap: wrap;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 1em;
    }
    .result {
      margin-top: 20px;
      font-weight: bold;
      white-space: pre-line;
    }
    hr {
      margin: 20px 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #aaa;
      padding: 6px 8px;
      text-align: center;
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      font-size: 0.95em;
    }
    .delete-btn {
      background: #ff6666;
      border: none;
      padding: 4px 8px;
      cursor: pointer;
      color: white;
      border-radius: 4px;
      font-weight: bold;
    }
    @media (max-width: 600px) {
      .form-row label {
        flex: 0 0 100%;
        margin-bottom: 6px;
        text-align: left;
      }
      .form-row input, .form-row select {
        max-width: 100%;
        flex: 1 1 100%;
      }
      .checkbox-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }
      button {
        width: 100%;
        font-size: 1.1em;
      }
    }
  </style>
</head>
<body>

<h1>è§’è‰²è¡Œå‹•å€¼è¨ˆç®—å™¨</h1>

<section>
  <h2>è¡Œå‹•å€¼è¨ˆç®—</h2>
  <div class="form-row">
    <label for="baseSpeed">è§’è‰²åŸºç¤é€Ÿåº¦</label>
    <input type="number" id="baseSpeed" value="107" min="0" />
  </div>
  <div class="form-row">
    <label for="outerSpeed">è§’è‰²å±€å¤–é€Ÿåº¦</label>
    <input type="number" id="outerSpeed" value="169" min="0" />
  </div>
  <div class="form-row">
    <label for="otherSpeedBoost">å…¶ä»–é€Ÿåº¦åŠ æˆ(%)</label>
    <input type="number" id="otherSpeedBoost" value="22" min="0" max="100" />
  </div>
  <div class="form-row">
    <label for="advancePct">è¡Œå‹•æå‰(%)</label>
    <input type="number" id="advancePct" value="40" min="0" max="100" />
  </div>
  <div class="checkbox-row">
    <label><input type="checkbox" id="wakeupAdvance" checked /> ç¿ç“¦å…‹è¡Œå‹•æå‰(40%)</label>
  </div>

  <button id="calcBtn">è¨ˆç®—è¡Œå‹•æ¬¡æ•¸</button>
  <div class="result" id="calcResult"></div>
</section>

<hr />

<section>
  <h2>åæ¨é€Ÿåº¦éœ€æ±‚</h2>
  <div class="form-row">
    <label for="targetActions">é è¨ˆè¦è¡Œå‹•æ¬¡æ•¸</label>
    <input type="number" id="targetActions" value="4" min="1" />
  </div>
  <button id="reverseCalcBtn">åæ¨é€Ÿåº¦</button>
  <div class="result" id="reverseResult"></div>
</section>

<hr />

<section>
  <h2>è§’è‰²è¨˜éŒ„ç®¡ç†</h2>
  <button id="addRecordBtn">ï¼‹æ–°å¢è§’è‰²</button>
  <button id="saveRecordsBtn">ğŸ’¾ å„²å­˜æ‰€æœ‰è§’è‰²è¨˜éŒ„</button>
  <table id="recordTable" aria-label="è§’è‰²è¨˜éŒ„è¡¨">
    <thead>
      <tr>
        <th>è§’è‰²åç¨±</th>
        <th>åŸºç¤é€Ÿåº¦</th>
        <th>å…‰éŒé€Ÿåº¦åŠ æˆ</th>
        <th>å…‰éŒåŠ æˆç¯„åœ</th>
        <th>æŠ€èƒ½é€Ÿåº¦åŠ æˆ</th>
        <th>æŠ€èƒ½é¡å‹</th>
        <th>è¡Œå‹•æå‰(%)</th>
        <th>åˆªé™¤</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<script>
  const FIXED_ACTION_VALUE = 150;
  const BASE_ACTION_COST = 10000;

  // è¨ˆç®—å±€å…§é€Ÿåº¦
  function calcInnerSpeed(baseSpeed, outerSpeed, otherBoostPercent) {
    return outerSpeed + baseSpeed * (otherBoostPercent / 100);
  }
  // è¨ˆç®—è¡Œå‹•å€¼æ¶ˆè€—
  function actionCost(n, advancePercent, innerSpeed) {
    return (n * BASE_ACTION_COST - BASE_ACTION_COST * advancePercent / 100) / innerSpeed;
  }
  // è¨ˆç®—å¯è¡Œå‹•æ¬¡æ•¸
  function calcMaxActions(advancePercent, innerSpeed) {
    let n = 1;
    while(actionCost(n+1, advancePercent, innerSpeed) <= FIXED_ACTION_VALUE) {
      n++;
    }
    return n;
  }
  // åæ¨å±€å…§é€Ÿåº¦éœ€æ±‚
  function reverseInnerSpeed(n, advancePercent) {
    return (BASE_ACTION_COST * (n - advancePercent / 100)) / FIXED_ACTION_VALUE;
  }
  // åæ¨å±€å¤–é€Ÿåº¦éœ€æ±‚
  function reverseOuterSpeed(innerSpeed, baseSpeed, otherBoostPercent) {
    return innerSpeed - baseSpeed * (otherBoostPercent / 100);
  }

  // DOM
  const baseSpeedInput = document.getElementById("baseSpeed");
  const outerSpeedInput = document.getElementById("outerSpeed");
  const otherBoostInput = document.getElementById("otherSpeedBoost");
  const advanceInput = document.getElementById("advancePct");
  const wakeupCheckbox = document.getElementById("wakeupAdvance");
  const calcBtn = document.getElementById("calcBtn");
  const calcResult = document.getElementById("calcResult");

  const targetActionsInput = document.getElementById("targetActions");
  const reverseCalcBtn = document.getElementById("reverseCalcBtn");
  const reverseResult = document.getElementById("reverseResult");

  const addRecordBtn = document.getElementById("addRecordBtn");
  const saveRecordsBtn = document.getElementById("saveRecordsBtn");
  const recordTableBody = document.querySelector("#recordTable tbody");

  // è¨ˆç®—è¡Œå‹•æ¬¡æ•¸
  function doCalc() {
    const baseSpeed = parseFloat(baseSpeedInput.value) || 0;
    const outerSpeed = parseFloat(outerSpeedInput.value) || 0;
    const otherBoost = parseFloat(otherBoostInput.value) || 0;
    let advance = parseFloat(advanceInput.value) || 0;
    if(wakeupCheckbox.checked) advance = 40;

    const innerSpeed = calcInnerSpeed(baseSpeed, outerSpeed, otherBoost);
    const maxActions = calcMaxActions(advance, innerSpeed);
    const nextActionCount = maxActions + 1;
    const needInnerSpeed = reverseInnerSpeed(nextActionCount, advance);
    const needOuterSpeed = reverseOuterSpeed(needInnerSpeed, baseSpeed, otherBoost);

    let text = `è§’è‰²å±€å…§é€Ÿåº¦ç‚º ${innerSpeed.toFixed(2)}\n` +
               `å›ºå®šè¡Œå‹•å€¼ ${FIXED_ACTION_VALUE} å…§ï¼Œå¯è¡Œå‹• ${maxActions} æ¬¡\n\n` +
               `è‹¥è¦è¡Œå‹• ${nextActionCount} æ¬¡ï¼Œéœ€å±€å…§é€Ÿåº¦é” ${needInnerSpeed.toFixed(2)}\n` +
               `å°æ‡‰å±€å¤–é€Ÿåº¦éœ€é” ${needOuterSpeed.toFixed(2)}`;
    calcResult.textContent = text;
  }
  calcBtn.addEventListener("click", doCalc);

  // åæ¨é€Ÿåº¦éœ€æ±‚
  function doReverseCalc() {
    const baseSpeed = parseFloat(baseSpeedInput.value) || 0;
    const otherBoost = parseFloat(otherBoostInput.value) || 0;
    const targetActions = parseInt(targetActionsInput.value) || 1;
    let advance = parseFloat(advanceInput.value) || 0;
    if(wakeupCheckbox.checked) advance = 40;
    const innerSpeedNeeded = reverseInnerSpeed(targetActions, advance);
    const outerSpeedNeeded = reverseOuterSpeed(innerSpeedNeeded, baseSpeed, otherBoost);

    reverseResult.textContent = 
      `è¦é”åˆ° ${targetActions} æ¬¡è¡Œå‹•ï¼Œå±€å…§é€Ÿåº¦éœ€ ${innerSpeedNeeded.toFixed(2)}ï¼Œ` + 
      `å±€å¤–é€Ÿåº¦éœ€ ${outerSpeedNeeded.toFixed(2)}`;
  }
  reverseCalcBtn.addEventListener("click", doReverseCalc);

  // è§’è‰²è¨˜éŒ„ç®¡ç†
  let records = [];

  // å¾localStorageè®€å–è¨˜éŒ„
  function loadRecords() {
    const saved = localStorage.getItem("actionCalcRecords");
    if(saved) {
      records = JSON.parse(saved);
    } else {
      records = [];
    }
  }
  // å„²å­˜åˆ°localStorage
  function saveRecords() {
    // å…ˆæŠŠè¡¨æ ¼è³‡æ–™è®€å› records
    records = [];
    const rows = recordTableBody.querySelectorAll("tr");
    rows.forEach(row => {
      const inputs = row.querySelectorAll("input, select");
      if(inputs.length === 0) return;
      const rec = {
        name: inputs[0].value.trim(),
        baseSpeed: parseFloat(inputs[1].value) || 0,
        coneBoost: parseFloat(inputs[2].value) || 0,
        coneRange: inputs[3].value,
        skillBoost: parseFloat(inputs[4].value) || 0,
        skillType: inputs[5].value,
        advancePct: parseFloat(inputs[6].value) || 0
      };
      records.push(rec);
    });
    localStorage.setItem("actionCalcRecords", JSON.stringify(records));
    alert("è§’è‰²è¨˜éŒ„å·²å„²å­˜");
  }
  saveRecordsBtn.addEventListener("click", saveRecords);

  // å»ºç«‹ä¸€åˆ—è§’è‰²è¼¸å…¥æ¡†
  function createRecordRow(record = {}) {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td><input type="text" value="${record.name||''}" placeholder="è§’è‰²åç¨±" /></td>
      <td><input type="number" value="${record.baseSpeed||0}" min="0" /></td>
      <td><input type="number" value="${record.coneBoost||0}" min="0" /></td>
      <td><input type="text" value="${record.coneRange||''}" placeholder="å…‰éŒåŠ æˆç¯„åœ" /></td>
      <td><input type="number" value="${record.skillBoost||0}" min="0" /></td>
      <td>
        <select>
          <option value="æ˜Ÿé­‚" ${record.skillType==='æ˜Ÿé­‚'?'selected':''}>æ˜Ÿé­‚</option>
          <option value="å¤©è³¦" ${record.skillType==='å¤©è³¦'?'selected':''}>å¤©è³¦</option>
          <option value="ç„¡" ${record.skillType==='ç„¡'?'selected':''}>ç„¡</option>
        </select>
      </td>
      <td><input type="number" value="${record.advancePct||0}" min="0" max="100" /></td>
      <td><button class="delete-btn" type="button">åˆªé™¤</button></td>
    `;

    // åˆªé™¤æŒ‰éˆ•äº‹ä»¶
    tr.querySelector(".delete-btn").addEventListener("click", () => {
      tr.remove();
    });

    return tr;
  }

  function renderRecords() {
    recordTableBody.innerHTML = "";
    records.forEach(rec => {
      recordTableBody.appendChild(createRecordRow(rec));
    });
  }

  addRecordBtn.addEventListener("click", () => {
    recordTableBody.appendChild(createRecordRow());
  });

  // é é¢åˆå§‹åŒ–
  function init() {
    loadRecords();
    renderRecords();
    doCalc();
  }
  init();

</script>

</body>
</html>
